# Note For Embedding

## 1. Basic C/C++

### fopen

```c
FILE *fopen(const char *filename, const char *mode);
```

`mode`参数:

| mode |                    desc                    |
| :--: | :----------------------------------------: |
|  r   |           只读文本，不存在则失败           |
|  w   |      只写文本，截断文件，不存在则创建      |
|  a   | 追加文本，写入位置在文件末尾，不存在则创建 |
|  b   |            替换为**二进制**操作            |
|  +   |                    读写                    |

> `rb+`：读写（二进制），文件必须存在

### :question:struct

```c
struct Question1 {
    char a;			// 占用 1 字节
    double b;		// 占用 8 字节，但为对齐前面补上 7 字节
    int c;			// 占用 4 字节
    char d[];		// 占用 0 字节
    // 需整体对齐到8（最大成员`double`），故填充4字节
};	
```

- 实际占 `24` 个字节

```c
#pragma pack(2)
struct Question2 {
    char a;
    int b;
    short c;
}; //__attribute__((packed))
#pragma pack()
```

- 实际占 `8` 个字节

### setvbuf

- 缓冲类型：

  - **全缓冲**（`_IOFBF`）：缓冲区满时刷新（默认用于文件）。
  - **行缓冲**（`_IOLBF`）：遇到换行符或缓冲区满时刷新（默认用于终端）。
  - **无缓冲**（`_IONBF`）：直接读写。

- 手动设置缓冲

  ```c
  char buffer[1024];
  setvbuf(fp, buffer, _IOFBF, sizeof(buffer)); // 设置全缓冲
  ```

## 2. Hardware

### :star2:CAN

特点：

- **多主架构**：任何节点均可主动发起通信。
- **非破坏性仲裁**：基于标识符优先级解决冲突，高优先级帧继续发送。
- **差分信号**：使用CAN_H和CAN_L双绞线传输，抗干扰能力强。（压差2V：逻辑 0 **显性**电平，压差0V：逻辑 1 **隐性**电平）。
- **高可靠性**：内置CRC校验、错误检测与恢复机制。

#### :sparkles:**数据链路层**：

|   帧类型   |                        用途                        |
| :--------: | :------------------------------------------------: |
| **数据帧** |        用于发送单元向接收单元传送数据的帧。        |
| **遥控帧** | 用于接收单元向具有相同 ID 的发送单元请求数据的帧。 |
| **错误帧** |     用于当检测出错误时向其它单元通知错误的帧。     |
| **过载帧** |      用于接收单元通知其尚未做好接收准备的帧。      |

##### 数据帧：

用于发送单元向接收单元传送数据的帧。

- **标准帧（11位ID）**：

  ```
  SOF | ID (11位) | RTR | IDE | r0 | DLC (4位) | Data (0-8字节) | CRC (15位) | CRC Delimiter | ACK Slot | ACK Delimiter | EOF
  帧起始 --> 仲裁段       --> 控制段              --> 数据段        --> CRC                     --> 帧结束
  ```

- **扩展帧（29位ID）**：

  ```
  SOF | ID (11位) | SRR | IDE | ID扩展 (18位) | RTR | r1 | DLC (4位) | Data (0-8字节) | CRC | CRC Delimiter | ACK Slot | ACK Delimiter | EOF
  ```

**关键字段说明**：

- **SOF（Start Of Frame）**：显性电平，标志帧开始。
- **ID（Identifier）**：决定帧优先级，数值越小优先级越高。
- **RTR（Remote Transmission Request）**：0表示数据帧，1表示远程帧。
- **DLC（Data Length Code）**：数据段长度（0-8字节）。
- **CRC（Cyclic Redundancy Check）**：校验数据段和控制场。
- **ACK Slot**：发送节点发送隐性位，接收节点以显性位确认。

> Q1：CAN的CRC校验是否覆盖ACK场？
>
> A1：不覆盖。ACK场由接收方在确认阶段填充，不属于发送方数据的一部分。CRC校验范围包括SOF、仲裁场、控制场、数据场。
>
> Q2：CAN的CRC校验是否包含填充位？
> A2：不包含。CRC计算基于原始未填充的数据，填充位由数据链路层在CRC计算后插入。

##### **遥控帧**

用于接收单元向具有相同 ID 的发送单元请求数据的帧。

### PCIe

一种**高速串行点对点**总线标准，用于连接处理器与外围设备（如显卡、SSD、网卡等）。

特点：

- **差分信号传输**：使用TX+/TX-和RX+/RX-双绞线，抗干扰能力强。
- **点对点拓扑**：每个设备独占链路（Lane），避免总线争用。
- **分层协议栈**：物理层、数据链路层、事务层与应用层分离，支持模块化设计。
- **可扩展带宽**：通过增加通道数（x1、x4、x8、x16）和提升速率（Gen1~Gen6）扩展带宽。

#### 物理层

1. **通道（Lane）与链路（Link）**

   - **单通道（x1）**：包含1对TX和1对RX差分线，独立传输数据。
   - **多通道链路**：x4、x8、x16链路通过聚合多个通道提升带宽（如x16=16条双向通道）。

2. **编码与速率**

   | PCIe版本 |  编码方式   | 单通道速率（GT/s） | 单通道带宽 |
   | :------: | :---------: | :----------------: | :--------: |
   |   Gen1   |   8b/10b    |        2.5         |  250 MB/s  |
   |   Gen2   |   8b/10b    |        5.0         |  512 MB/s  |
   |   Gen3   |  128b/130b  |        8.0         |  ~1 GB/s   |
   |   Gen4   |  128b/130b  |        16.0        |  ~2 GB/s   |
   |   Gen5   |  128b/130b  |        32.0        |  ~4 GB/s   |
   |   Gen6   | PAM4 + FLIT |        64.0        |  ~8 GB/s   |

3. **物理层功能**

   - **信号调制**：NRZ（Non-Return-to-Zero）或PAM4（Gen6）。
   - **时钟恢复**：接收端通过CDR（Clock Data Recovery）从数据流中提取时钟。
   - **链路训练**：自动协商速率、通道极性、均衡参数（如预加重/去加重）。

#### 协议层

##### 1. **事务层（Transaction Layer）**

- **TLP（Transaction Layer Packet）**：

  - **头部（Header）**：包含事务类型（读/写/配置）、地址、长度等信息。
  - **数据载荷（Data Payload）**：最大4096字节（Gen3及以上）。
  - **ECRC（End-to-End CRC）**：可选校验字段，保护端到端数据完整性。

- **事务类型**：

  |       类型        |          用途          |
  | :---------------: | :--------------------: |
  | Memory Read/Write |    访问设备内存空间    |
  |   Configuration   |    读写设备配置空间    |
  |      Message      | 传递中断、电源管理信号 |

##### 2. **数据链路层（Data Link Layer）**

- DLLP（Data Link Layer Packet）：
  - **流量控制**：发送ACK/NAK管理缓冲区状态。
  - **链路维护**：心跳包（Keepalive）检测链路存活。
- 序列号与重传：
  - 每个TLP分配序列号，接收端通过ACK确认，超时或错误触发重传。
  - **LCRC（Link CRC）**：校验TLP在链路上的传输完整性。



## 3. RTOS

### OSInit

- **初始化 μC/OS-II 内核的所有数据结构**（初始化**内核变量** `OSRunning`/`OSIntNesting`，空闲任务`Idle Task`，任务控制块`TCB`，就绪列表，内存管理，定时器等），为多任务环境搭建基础框架。

- 必须在创建任务（`OSTaskCreate()`）和启动调度器（`OSStart()`）前调用。

> Q1：`OSInit()` 是否会初始化用户任务的堆栈？
>
> A1：不会。`OSInit()` 仅初始化内核数据结构和系统任务（如空闲任务），用户任务的堆栈需在 `OSTaskCreate()` 中自行分配。

### OSIntEnter/OSIntExit

- **`OSIntEnter()`**：

  - 将全局变量 `OSIntNesting` 加 1，记录嵌套层数。

  - **不关闭中断**，允许更高优先级中断抢占。

```c
void OSIntEnter(void) {
    if (OSRunning == OS_TRUE) {
        OS_CPU_CRITICAL_ENTER();
        OSIntNesting++;  // 嵌套计数器递增
        OS_CPU_CRITICAL_EXIT();
    }
}
```

- **`OSIntExit()`**：
  - 递减 `OSIntNesting`，当嵌套层数为 0 时触发任务调度。
  - 调用 `OS_SchedNew()` 查找最高优先级任务，若需要切换则执行上下文切换。
  - 必须 **在 ISR 末尾调用**，否则可能导致任务调度延迟。

> Q1：若忘记调用 `OSIntExit()` 会导致什么问题？
>
> A1：`OSIntNesting` 无法递减，任务调度被阻塞，系统可能卡在中断上下文无法返回任务模式。



## 4. Linux

#### net_device

描述网络设备的**核心数据结构**，每个网络接口（如以太网卡、虚拟网卡）在内核中均对应一个 `net_device` 实例。

1. **基础信息与配置**

- `mtu`：最大传输单元（Maximum Transmission Unit），默认 1500 字节。
- `flags`：设备状态标志，如 `IFF_UP`（设备已启动）、`IFF_PROMISC`（混杂模式）。
- `features`：硬件特性支持，如校验和卸载（`NETIF_F_HW_CSUM`）、TSO。

2. **操作函数集**

- `ndo_open`：打开设备（如申请资源、启用中断）。

- `ndo_stop`：关闭设备（如释放资源、禁用中断）。

- `ndo_start_xmit`：发送数据包（将 `sk_buff` 提交到硬件队列）。

- `ndo_get_stats`：获取设备统计信息（发送/接收字节数、错误计数等）。

- `ndo_do_ioctl`：处理用户空间 `ioctl` 命令（如设置混杂模式）。

- `ndo_set_rx_mode`：设置接收模式（如更新 MAC 过滤器）。

3. **队列与中断管理**

- `napi_struct`：NAPI（New API）结构体，用于在高负载时轮询接收数据包，减少中断开销。
- `tx_queue_len`：发送队列最大长度（若设备支持队列管理）。



## 5. 计算机网络 

### 一、计算机网络基础

![img](https://camo.githubusercontent.com/de91fb330139de1ab20aa7d7de9e10e3c1f5e1c99d0c623e573441ce3f067fa1/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f30666136633233372d613930392d346532612d613737312d3263353438356364386365302e706e67)

#### 1. OSI 七层模型

- **物理层** ：定义电气、机械和时序接口，传输原始**`比特流`**（0/1）。

- **数据链路层** ：将比特流封装成**`帧`**（Frame），提供节点到节点的可靠传输（如MAC地址寻址、CRC校验）。
- **网络层** ：实现逻辑寻址（IP地址）和路由选择（跨网络的数据传输）。数据单位为**`数据报`**。
- **传输层** ：提供端到端的数据传输服务：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为**`报文段`**；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户**`用户数据报`**。
- 会话层 ：管理会话（连接建立、维护、终止）。
- 表示层 ：数据格式转换（加密、压缩、编码）。
- **应用层** ：提供用户接口和网络服务（如HTTP、DNS、FTP、SMTP/POP3、MQTT）。

#### 2. 数据封装

数据在发送时从高层向低层逐层封装，接收时反向解封装：

- **封装过程**（以发送HTTP数据为例）：
  1. 应用层：HTTP报文 → 添加HTTP头。
  2. 传输层：添加TCP头（源端口、目的端口）。
  3. 网络层：添加IP头（源IP、目的IP）。
  4. 数据链路层：添加以太网头（源MAC、目的MAC）和CRC校验。
  5. 物理层：转换为比特流通过网卡发送。

### 二、物理层

​	物理层是OSI模型的最底层，负责在物理介质上透明传输原始比特流，不关心数据的含义，仅关注如何通过电信号、光信号或电磁波表示“0”和“1”。

#### 1. 通信方式

(1) 单工/半双工/全双工通信

- **单工（Simplex）**：单向通信（如广播、传感器只发送数据）。
- **半双工（Half-Duplex）**：双向交替通信（如对讲机、I2C总线）。
- **全双工（Full-Duplex）**：双向同时通信（如电话、UART、SPI双线通信）。

(2) 串行通信 vs 并行通信

- **串行通信**：逐位传输（单条数据线），抗干扰强，适合长距离。
- **并行通信：**多位同时传输（多条数据线），速率快但易受干扰，适合短距离。

#### 2. 传输介质

(1) 有线介质：双绞线、同轴电缆、光纤。

(2) 无线介质：无线电波、微波、红外线。

#### 3. 物理层设备

- 中继器（Repeater）：
  - **功能**：放大电信号，延长传输距离（解决信号衰减）。
  - **局限**：不识别数据内容，可能放大噪声。
- 集线器（Hub）：
  - **功能**：多端口中继器，广播式转发数据（所有端口收到相同数据）。
  - **缺点**：效率低（半双工），不能隔离冲突域也不能隔离广播域。

#### 4. 物理层技术

**（1）调制与编码**

- 调制（Modulation）：将数字信号转换为模拟信号（适应信道传输）
  - **调幅（ASK）**：通过振幅表示“0”和“1”。
  - **调频（FSK）**：通过频率变化表示数据。
  - **调相（PSK）**：通过相位变化表示数据（如QPSK、8PSK）。
  - **正交幅度调制（QAM）**：结合相位和幅度（如16-QAM、64-QAM）。
- 编码（Encoding）：数字信号到数字信号的转换（优化传输）。
  - **曼彻斯特编码**：每位中间跳变表示“0”或“1”（自带同步时钟）。
  - **差分曼彻斯特编码**：每位开始跳变表示“0”，无跳变表示“1”。

**（2）信道复用技术**

- 频分复用（FDM）：不同信号分配不同频段（如广播电台、Wi-Fi信道）。
- 时分复用（TDM）：不同信号轮流占用信道时间片（如传统电话网络）。
- 码分复用（CDM）：通过唯一编码区分信号（如CDMA移动通信）。
- 波分复用（WDM）：光纤中不同波长（颜色）传输多路信号（如DWDM密集波分复用）。

#### 5. 性能指标

- 比特率（Bit Rate）：单位时间传输的比特数 = 波特率 × 每个信号携带的比特数。

- 奈奎斯特定理（Nyquist Theorem）：理想无噪声信道最大比特率 = 2 × 带宽 × log₂V（V为信号离散等级数）。
- 香农定理（Shannon Theorem）：有噪声信道最大比特率 = 带宽 × log₂(1 + S/N)（S/N为信噪比）。

### 三、数据链路层

​	数据链路层负责在直接相连的节点（通过物理层）之间实现可靠的数据传输。它通过帧（Frame）为单位传输数据，解决物理层可能出现的错误，并管理多设备共享信道的问题。

#### 1. 核心功能

（1）封装成帧

将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。

- 帧结构：首部（目标MAC地址、源MAC地址、类型等） + 数据（上层协议报文） + 尾部（校验码）。

![img](https://pica.zhimg.com/v2-534a4aa6c789e03d6a7eea0817c8e2e2_1440w.jpg)

（2）透明传输

解决数据中与帧界定符冲突的问题。

- **字节填充**：在特殊字符（如`0x7E`）前插入转义字符（如`0x7D`）。
- **比特填充**：在连续5个1后插入一个0（如HDLC协议）。

（3）差错控制

差错类型：比特差错（0变1或1变0）、帧丢失、帧重复、帧失序。

差错检测：

- **CRC（循环冗余校验）**：通过多项式除法生成校验码（如以太网FCS字段）。
- **奇偶校验**：简单但漏检率高（仅检测奇数位错误）。

#### 2. 关键协议与技术

（1）点对点协议（PPP）

- 用途：拨号上网、路由器间广域网连接。
- 特点：支持身份验证（PAP/CHAP）和多种网络层协议（通过协议字段区分IP/IPX等）。
- 帧格式：标志位（`0x7E`）+地址/控制字段（固定值）+协议+数据+FCS。

（2）**以太网（IEEE 802.3）**

- **CSMA/CD（载波侦听多路访问/冲突检测）**

1. 发送前侦听信道是否空闲。
2. 若空闲则发送，若冲突则等待随机时间后重试。
3. 冲突检测：边发送边监听，冲突时发送拥塞信号。

- MAC地址：48位全局唯一标识符，用于唯一标识网络适配器（网卡）。
- 以太网**帧格式**：前导码（7B） + 帧起始定界符（1B） + 目标MAC（6B） + 源MAC（6B） + 类型（2B） + 数据（46-1500B） + FCS（4B）。

（3）虚拟局域网（VLAN）

在物理局域网中划分逻辑子网，隔离广播域。

- 实现方式：
  - 基于端口：交换机端口绑定到不同VLAN。
  - 基于MAC地址：按设备MAC划分VLAN。
  - 基于协议/IP子网：按上层协议类型或IP地址划分。
- VLAN标签（IEEE 802.1Q）：在以太网帧头部插入4字节标识（包含VLAN ID）。

#### 3. 数据链路层设备

（1）网桥（Bridge）

连接两个局域网，基于MAC地址过滤转发帧。

- 特点：分割冲突域（每个端口是一个冲突域），不分割广播域（所有端口属于同一广播域）。

（2）交换机（Switch）

多端口网桥（支持全双工）。

- MAC地址表：记录端口与MAC地址的映射，通过自学习更新。

### 四、网络层

​	负责在不同网络之间实现逻辑寻址、路由选择和分组转发。它通过`IP`协议实现端到端的数据传输，解决数据链路层无法跨网络通信的问题。

#### 1. 网络层核心功能

**（1）逻辑寻址与IP协议**

- IP地址：
  - **IPv4**：32位地址，分为**网络号**和**主机号**（通过子网掩码划分）。
  - **IPv6**：128位地址，解决IPv4地址耗尽问题，支持无状态地址自动配置。
- 子网划分与CIDR：
  - **子网掩码**：标识IP地址的网络部分（如`255.255.255.0`）。
  - **CIDR（无类域间路由）**：用斜杠表示法（如`192.168.1.0/24`）替代传统子网划分，提高地址利用率。

**（2）路由选择**

- **路由表**：存储目标网络与下一跳的映射关系（通过直连、静态或动态路由生成）。
- 动态路由协议：
  - RIP（路由信息协议）：
    - 基于距离向量算法，最大跳数15，适用于小型网络。
    - 每隔30秒广播路由表，收敛速度慢。

  - OSPF（开放最短路径优先）：
    - 基于链路状态算法，划分区域（Area 0为骨干区域）减少计算量。
    - 支持分层路由和负载均衡。

  - BGP（边界网关协议）：
    - 用于自治系统（AS）之间的路由（路径向量协议）。
    - 通过属性（AS_PATH、NEXT_HOP等）选择最佳路径。

**（3）分组转发**

- 转发流程：
  1. 提取目标IP地址，查询路由表。
  2. 匹配最长前缀（Longest Prefix Match）确定下一跳。
  3. 通过ARP协议（IPv4）或NDP协议（IPv6）解析下一跳的MAC地址。
  4. 将数据包封装为数据链路层帧并发送。
- 分片与重组：
  - **MTU（最大传输单元）**：数据链路层允许的最大数据长度（如以太网MTU=1500字节）。
  - 若数据包超过MTU，网络层将其分片（IPv4支持，IPv6仅在源端分片）。
  - 分片字段：标识（16位）+标志（3位，DF/MF）+片偏移（13位）。

**（4）网络层服务**

- NAT（网络地址转换）：将私有IP地址映射为公有IP地址（解决IPv4地址不足）。

  - 类型：
    - 静态NAT（一对一映射）。
    - 动态NAT（多对多映射，需地址池）。
    - PAT（端口地址转换，多对一映射，通过端口号区分会话）。
  
- **ICMP**（互联网控制报文协议）：传递网络错误信息，它封装在IP数据报当中，但不属于高层协议。

    - **应用**：`ping`测试两台主机之间的连通性; `traceroute`探测IP数据包在网络中走过的路径

    - 报文类型：
      - 查询报文（如Echo Request/Reply）。
      - 差错报文（如Destination Unreachable）。


#### 2. 关键协议与技术

**（1）IPv4协议**

![img](.asset/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f38356330356662312d353534362d346335302d393232312d3231663233316364633863352e6a7067.jpeg)

- 数据包结构

  ```plaintext
  | 版本(4b) | 头部长度(4b) | 服务类型(8b) | 总长度(16b) |
  |--------------标识(16b)---------------|
  | 标志(3b) | 片偏移(13b) | TTL(8b) | 协议(8b) | 头部校验和(16b) |
  | 源IP地址(32b) | 目标IP地址(32b) |
  | 选项(可选) | 数据 |
  ```

  - 版本 : 4（IPv4）或 6（IPv6）。
  - 总长度 : 包括首部长度和数据部分长度。
  - **TTL**（生存时间）：防止数据包无限循环（每经过路由器减1，为0时丢弃）。
  - **协议号**：标识上层协议（如6=TCP，17=UDP）。
  - 协议 ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
  - 首部检验和 ：不包含数据部分。
  - **标识** : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
  - **片偏移** : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

![img](https://camo.githubusercontent.com/42a5bc7537a952707b2985f22ed9d160cd3f4d1c92c1ed5ea9c05c2acdc681c7/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f32336261383930652d653131632d343565322d613230632d3634643231376638333433302e706e67)

**（3）ARP/RARP/NDP**

- ARP（地址解析协议）：建立IP地址到对应的硬件MAC地址的动态映射。ARP表是自动建立的，不需要系统管理员来配置。
  - 通过广播查询目标IP对应的MAC地址，缓存结果（ARP表）。
  - 报文类型：ARP Request（广播）、ARP Reply（单播）。
- RARP（逆地址解析协议）：把数据链路层MAC48位地址转化为网络层32位地址。
- NDP（邻居发现协议，IPv6）：
  - 替代ARP，支持无状态地址配置（SLAAC）和重复地址检测（DAD）。

#### 3. 网络层设备

**（1）路由器（Router）**

- 功能：
  - 连接不同网络，基于IP地址转发数据包。
  - 运行路由协议（如OSPF、BGP），维护路由表。
- 与交换机的区别：
  - 交换机基于MAC地址转发（数据链路层），路由器基于IP地址转发（网络层）。
  - **路由器分割广播域，交换机分割冲突域**。

#### :question:常见问题

Q1：将`192.168.1.0/24`划分为4个子网，写出每个子网的地址范围（包括网络地址和广播地址）。

A1：需要借用2位主机位，新子网掩码：`/26`，子网间隔：64，每个子网可用地址数：$2^6-2=62$（排除网络地址和广播地址）。

Q2：一个数据包长度为4000字节，链路层MTU为1500字节，计算分片数量和每个分片的偏移量（假设IP头部为20字节）。

A2：

1. 计算分片数量：

   - **MTU限制**：数据部分最大为1500−20=1480字节。
   - **原始数据长度**：4000字节（总长度） - 20字节（IP头部） = 3980字节。
   - 除最后一个分片外，其他分片的数据长度必须是8的倍数（偏移量按8字节为单位计算）。

   - 第一个分片：数据长度1480字节（满足8的倍数：1480÷8=185）。

   - 第二个分片：数据长度1480字节。

   - 第三个分片：剩余数据 = 3980−1480×2=1020字节。

2. 计算偏移量 = 前一个分片的数据长度 / 8

| **分片** | **总长度（字节）** | **偏移量**  | **MF标志** |
| :------: | :----------------: | :---------: | :--------: |
|  分片1   |        1500        |      0      |     1      |
|  分片2   |        1500        | 1480÷8=185  |     1      |
|  分片3   |        1040        | 185+185=370 |     0      |

### 五、传输层

​	负责端到端（进程到进程）的通信，核心任务是**可靠传输**（TCP）或**高效传输**（UDP）。

#### 1. 传输层核心功能

（1）进程到进程通信

- 端口号（Port）：标识主机上的应用程序（16位整数，0~65535）。

**（2）传输服务类型**

- TCP（传输控制协议）：
  - 面向连接（需三次握手建立连接）。
  - 可靠传输（确认、重传、流量控制、拥塞控制）。
  - 适用于文件传输、网页浏览等需可靠性的场景。
- UDP（用户数据报协议）：
  - 无连接（直接发送数据）。
  - 不可靠传输（无确认、无重传）。
  - 低延迟、低开销，适用于实时音视频、DNS查询等场景。

------

#### 2. TCP协议详解:eight_spoked_asterisk:

（1）TCP报文格式

![img](https://camo.githubusercontent.com/556ccf5f143f3564a6ae55c548479a9a4cd2079188e2c211641b1fe635c166ae/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f35356463346538342d353733642d346331332d613736352d3532656431646432353166392e706e67)

```plaintext
| 源端口(16b) | 目的端口(16b) |
|--------------序列号(32b)---------------|
|------------确认号(32b)------------------|
| 数据偏移(4b) | 保留(6b) | 控制位(6b) | 窗口大小(16b) |
| 校验和(16b) | 紧急指针(16b) |
| 选项(可选) | 数据 |
```

- 关键字段：
  - **序列号（Sequence Number）**：数据字节流的编号（解决乱序）。例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。
  - **确认号（Acknowledgment Number）**：期望收到的下一个字节序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。
  - 控制位：
    - `SYN`：建立连接。
    - `ACK`：确认报文有效。
    - `FIN`：关闭连接。
    - `RST`：强制断开连接。
    - `PSH`：接收方应立即推送数据给应用层。
    - `URG`：紧急数据（需配合紧急指针使用）。
  - **窗口大小（Window Size）**：接收方剩余缓冲区大小（流量控制）。

**（2）TCP连接管理** :star2:

![img](https://camo.githubusercontent.com/7dd2b7948c0d49f86a2dbe2caa150e15f346eb0044a9b24fe6a284aa0e2e8a03/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f65393264306562632d376434362d343133622d616563312d3334613339363032663738372e706e67)

- **三次握手（建立连接）**：

  1. 客户端→服务端：发送`SYN=1, seq=x`。
  2. 服务端→客户端：发送`SYN=1, ACK=1, seq=y, ack=x+1`。
  3. 客户端→服务端：发送`ACK=1, seq=x+1, ack=y+1`。

  - **目的**：同步初始序列号（ISN），协商参数。

> ***三次握手的原因***：第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

- **四次挥手（关闭连接）**：

![img](https://camo.githubusercontent.com/41f967d040f350b8a202f0bb7df695af46c5a340ae24be9fb119629cce6bc73e/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f66383761666537322d633264662d346331322d616330332d3962386435383161386166382e6a7067)

  1. 客户端→服务端：发送`FIN=1, seq=u`。
  2. 服务端→客户端：发送`ACK=1, ack=u+1`。
  3. 服务端→客户端：发送`FIN=1, ACK=1, seq=v, ack=u+1`。
  4. 客户端→服务端：发送`ACK=1, seq=u+1, ack=v+1`。

  - **TIME_WAIT状态**：等待2MSL（**确保最后一个ACK被接收**）。

> ***四次挥手的原因***：客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是**为了让服务器端发送还未传送完毕的数据**，传送完毕之后，服务器会发送 FIN 连接释放报文。

**（3）可靠传输机制**

- 确认与重传：
  - **超时重传**：发送数据后启动定时器，超时未收到ACK则重传。
  - **快速重传**：收到3个重复ACK时立即重传（无需等待超时）。
- 滑动窗口协议：

​	滑动窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

- **发送窗口**：允许连续发送的未确认数据范围。
- **接收窗口**：接收方缓冲区剩余空间，只会对窗口内最后一个按序到达的字节进行确认。

![img](https://camo.githubusercontent.com/62e749791cbc8aca342985906dae1ba7a961614e98580318d65327c4a0200bfd/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f61333235336465622d386432312d343061312d616165342d3764313738653461613331392e6a7067)

（4）流量控制

通过接收方窗口大小限制发送速率（防止接收方缓冲区溢出）。

> 接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方**不能**发送数据。

（5）拥塞控制

流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。即当网络出现拥塞时，控制发送方的速率。

- **慢开始**：窗口大小从1开始指数增长（直到阈值ssthresh）。
- **拥塞避免**：窗口线性增长 cwnd+1。如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。

![img](https://camo.githubusercontent.com/ee13230e8663e6d9ab3450d663f7ae15ceaa54d9ac2220a454fcfae694fbcbbf/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f39313066363133662d353134662d343533342d383764642d3962343639396435396433312e706e67)

- **快重传**：收到重复ACK时窗口减半，进入拥塞避免阶段。此时，ssthresh = cwnd / 2 ，cwnd = ssthresh。

![img](https://camo.githubusercontent.com/49913ca5cb927268c62d36f88e55a4bc4d4b1b78d2ffa6dca5a1944cf5edf4a3/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f66363162353431392d633934612d346466312d386434642d6165643961653863633664352e706e67)


#### **3. UDP协议详解**

**（1）UDP报文格式**

![img](https://camo.githubusercontent.com/9fe4e7c9bf1d549bc39728e9e50798e8e7ab3022d9f07929babfe5a2e49a139d/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f64346333613461312d303834362d343665632d396363332d6561646466636137313235342e6a7067)

```plaintext
| 源端口(16b) | 目的端口(16b) |
| 长度(16b) | 校验和(16b) |
| 数据 |
```

- **特点**：
  - 无连接、无需维护状态。
  - 首部字段开销小，只有 8 个字节，包括源端口、目的端口、长度、检验和。
  - 无拥塞控制，适合实时应用。

- **UDP校验和**：计算伪头部（源IP、目的IP、协议号等）+ UDP头部 + 数据的校验和。

------

#### **4. TCP与UDP对比**

|   **特性**   |       **TCP**        |       **UDP**       |
| :----------: | :------------------: | :-----------------: |
| **连接方式** | 面向连接（三次握手） |       无连接        |
|  **可靠性**  |  可靠（确认、重传）  |       不可靠        |
| **流量控制** |     滑动窗口机制     |         无          |
| **拥塞控制** |  慢启动、拥塞避免等  |         无          |
| **头部开销** |   大（20~60字节）    |     小（8字节）     |
| **适用场景** |  文件传输、Web浏览   | 实时音视频、DNS查询 |

#### :question:常见问题:

Q1：描述TCP三次握手的过程，并说明每一步的作用。若第二次握手报文丢失，会发生什么？

A1：**过程描述**：

1. 第一次握手（客户端→服务端）：客户端发送`SYN=1`，并随机生成初始序列号`seq=x`。
   - **作用**：客户端向服务端请求建立连接，并告知初始序列号。
2. 第二次握手（服务端→客户端）：服务端发送`SYN=1`、`ACK=1`，随机生成初始序列号`seq=y`，确认号`ack=x+1`。
   - **作用**：服务端确认客户端的连接请求，并告知自己的初始序列号。
3. 第三次握手（客户端→服务端）：客户端发送`ACK=1`，序列号`seq=x+1`，确认号`ack=y+1`。
   - **作用**：客户端确认服务端的响应，连接正式建立。

> ***三次握手的原因***：第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

**第二次握手丢失的影响**：

- 客户端未收到`SYN+ACK`，则会重传第一次握手报文（`SYN`）。
- 服务端未收到客户端的第三次`ACK`，会触发超时重传第二次握手报文（`SYN+ACK`）。

Q2：假设TCP连接初始阈值为16（单位：MSS，最大报文段大小），当前拥塞窗口（cwnd）为1 MSS。

1. 在慢启动阶段，经过3个RTT后，cwnd变为多少？
2. 当cwnd达到阈值后进入拥塞避免阶段，再经过2个RTT，cwnd变为多少？
3. 若此时检测到超时事件，阈值和cwnd将如何调整？

A2：1. `cwnd=2^3=8`; 2. `cwnd=16+2=18`; 3. `ssthresh=cwnd/2=9`, `cwnd=1`

### 六、应用层

​	为操作系统或网络应用程序提供访问网络服务的接口，数据传输基本单位为报文。

**常用协议**：

| **协议/技术** |     **核心功能**     |  **典型端口**  | 传输层协议 |
| :-----------: | :------------------: | :------------: | :--------: |
|   **HTTP**    | 网页数据传输（明文） |       80       |    TCP     |
|   **HTTPS**   |   加密网页数据传输   |      443       |    TCP     |
|    **DNS**    |       域名解析       |       53       |  *UDP/TCP  |
|   **DHCP**    |     动态主机配置     |     67/68      |    UDP     |
|   **SNMP**    |   简单网络管理协议   |    161/162     |    UDP     |
|   **SMTP**    |       发送邮件       | 25/465（SSL）  |    TCP     |
|   **POP3**    |    下载邮件到本地    | 110/995（SSL） |    TCP     |
|   **IMAP**    |   网际报文存取协议   | 143/993（SSL） |    TCP     |
|    **FTP**    |       文件传送       |     20/21      |    TCP     |
|    **SSH**    |     安全远程登录     |       22       |    TCP     |
|  **TELNET**   |       远程登录       |       23       |    TCP     |

#### 1. DNS（域名系统）

- **功能**：将域名（如`www.baidu.com`）解析为IP地址。
- **解析顺序**：浏览器缓存 -> 本机hosts文件 -> 路由缓存 -> DNS 服务器（本地域名、顶级域名、根域名）-> 迭代查询、递归查询。
- 域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

![img](https://camo.githubusercontent.com/ba84ae0a5f9251ab998db5fae461b2d341a1cdd6bb2b8a9abf4dfaee2dd38d51/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f62353465656231362d306230652d343834632d626536322d3330366635376334306437372e6a7067)

#### 2. DHCP（动态主机配置协议）

- **功能**：自动分配IP地址、子网掩码、网关、DNS服务器。
- 流程：
  1. 客户端广播`DHCP Discover`。
  2. 服务端响应`DHCP Offer`。
  3. 客户端请求`DHCP Request`。
  4. 服务端确认`DHCP ACK`。

#### ![img](https://camo.githubusercontent.com/57c8707e2c2ad6cb2f2cf649744b58bc48b9e465759a86583799bebac5ac2488/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f32333231396534632d396663302d343035312d623333612d3262643935626630353461622e6a7067)3. HTTP/HTTPS

- HTTP（超文本传输协议）：
  - **无状态协议**：默认不记录用户状态（依赖Cookie/Session）。
  - **请求方法**：`GET`（获取资源）、`POST`（提交数据）、`PUT`（更新资源）、`DELETE`（删除资源）等。
  - 状态码：
    - `1xx`：信息响应（如`100 Continue`）。
    - `2xx`：成功（如`200 OK`、`201 Created`）。
    - `3xx`：重定向（如`301 Moved Permanently`、`304 Not Modified`）。
    - `4xx`：客户端错误（如`404 Not Found`、`403 Forbidden`）。
    - `5xx`：服务端错误（如`500 Internal Server Error`）。
- HTTPS（HTTP over SSL/TLS）：基于HTTP协议，通过SSL或TLS提供加密处理数据、验证对方身份以及数据完整性保护。

#### 4. 远程登录协议

- **SSH（安全外壳协议）**：加密远程登录（端口22），替代不安全的Telnet。
- **Telnet**：明文传输（端口23），已逐渐被淘汰。

#### 5. 文件传输协议

- FTP（文件传输协议）：端口 21 控制连接，20 数据连接用于传送文件。分为主动模式（服务端主动连接客户端端口）和被动模式（客户端连接服务端随机端口）。
- **SFTP/SCP**：基于SSH的安全文件传输。

#### 6. **电子邮件协议**

- SMTP（简单邮件传输协议）：发送邮件（端口25/465）。流程：客户端→SMTP服务器→收件方SMTP服务器。
- POP3（邮局协议第3版）：从服务器下载邮件到本地（端口110/995），操作后邮件从服务器删除。
- IMAP（互联网消息访问协议）：在服务器管理邮件（端口143/993），支持多设备同步。
